<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC + Ably</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: #f0f0f0;
        }
        video {
            width: 45%;
            max-width: 600px;
            border: 2px solid #333;
            border-radius: 8px;
            margin: 10px;
            background: #000;
        }
        #controls {
            margin: 20px;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #status {
            color: #666;
            margin: 15px;
            font-size: 14px;
        }
    </style>
    <script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
</head>
<body>
    <h1>Видеозвонок через Ably</h1>
    <div id="status">Подключение...</div>
    <div id="controls">
        <button id="callBtn">Начать звонок</button>
    </div>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>

    <script>
        // Конфигурация
        const ABLY_KEY = 'QBEN4A.NpllMw:gKZi9zUxR4vJRISVloUyOSyO969QngOBQNAvtLSr3ZA';
        const ICE_SERVERS = [
            { urls: 'stun:stun.l.google.com:19302' },
            { 
                urls: 'turn:turn.anyfirewall.com:443',
                username: 'webrtc',
                credential: 'webrtc'
            }
        ];

        // Элементы DOM
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const callBtn = document.getElementById('callBtn');
        const statusEl = document.getElementById('status');
        
        let localStream;
        let peerConnection;
        let ably;
        let channel;
        let clientId;

        // Инициализация
        init();

        async function init() {
            try {
                // Получение медиапотока
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                localVideo.srcObject = localStream;
                
                // Подключение к Ably
                ably = new Ably.Realtime(ABLY_KEY);
                ably.connection.once('connected', () => {
                    clientId = ably.auth.clientId;
                    setupChannel();
                    updateStatus('Готов к подключению', 'green');
                    callBtn.disabled = false;
                });

            } catch (err) {
                console.error('Ошибка инициализации:', err);
                updateStatus('Ошибка: ' + err.message, 'red');
            }
        }

        function setupChannel() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room') || 'default-room';
            
            channel = ably.channels.get(`room-${roomId}`);
            
            // Подписка на сообщения
            channel.subscribe('signal', message => {
                if (message.clientId === clientId) return;
                
                const data = message.data;
                console.log('Получено сообщение:', data);
                
                switch(data.type) {
                    case 'offer':
                        handleOffer(data.offer);
                        break;
                    case 'answer':
                        handleAnswer(data.answer);
                        break;
                    case 'candidate':
                        handleCandidate(data.candidate);
                        break;
                }
            });
        }

        async function createPeerConnection() {
            peerConnection = new RTCPeerConnection({ iceServers: ICE_SERVERS });
            
            // Добавление локального потока
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // Обработка ICE кандидатов
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    channel.publish('signal', {
                        type: 'candidate',
                        candidate: event.candidate
                    });
                }
            };

            // Получение удаленного потока
            peerConnection.ontrack = event => {
                remoteVideo.srcObject = event.streams[0];
                updateStatus('Соединение установлено', 'green');
            };

            peerConnection.oniceconnectionstatechange = () => {
                updateStatus(`Состояние: ${peerConnection.iceConnectionState}`, 'blue');
            };
        }

        async function startCall() {
            await createPeerConnection();
            
            // Создание offer
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            // Отправка offer
            channel.publish('signal', {
                type: 'offer',
                offer: offer
            });
            
            updateStatus('Отправлен запрос на соединение...', 'orange');
        }

        async function handleOffer(offer) {
            await createPeerConnection();
            
            // Установка удаленного описания
            await peerConnection.setRemoteDescription(offer);
            
            // Создание answer
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            // Отправка answer
            channel.publish('signal', {
                type: 'answer',
                answer: answer
            });
        }

        async function handleAnswer(answer) {
            if (!peerConnection.currentRemoteDescription) {
                await peerConnection.setRemoteDescription(answer);
            }
        }

        async function handleCandidate(candidate) {
            try {
                await peerConnection.addIceCandidate(candidate);
            } catch (err) {
                console.error('Ошибка добавления ICE кандидата:', err);
            }
        }

        function updateStatus(text, color) {
            statusEl.textContent = text;
            statusEl.style.color = color;
        }

        // Очистка
        window.addEventListener('beforeunload', () => {
            if (peerConnection) peerConnection.close();
            if (ably) ably.close();
        });

        // Обработчик кнопки
        callBtn.addEventListener('click', startCall);
    </script>
</body>
</html>