<!DOCTYPE html>
<html>
<head>
    <title>Video Chat Fix</title>
    <script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
</head>
<body>
    <video id="local" autoplay muted></video>
    <video id="remote" autoplay></video>

<script>
const ABLY_KEY = 'QBEN4A.NpllMw:gKZi9zUxR4vJRISVloUyOSyO969QngOBQNAvtLSr3ZA';
const roomId = new URLSearchParams(location.search).get('room') || 'default';

let pc = null;
let ably = null;

async function init() {
    try {
        // 1. Инициализация Ably с явным clientId
        ably = new Ably.Realtime({
            key: ABLY_KEY,
            clientId: 'user-' + Math.random().toString(36).slice(2, 10)
        });

        // 2. Получение медиапотока
        const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
        document.getElementById('local').srcObject = stream;
        
        // 3. Настройка соединения
        await setupPeerConnection(stream);
        
    } catch(err) {
        console.error('Init error:', err);
    }
}

async function setupPeerConnection(stream) {
    try {
        pc = new RTCPeerConnection({
            iceServers: [{urls: "stun:stun.l.google.com:19302"}]
        });

        // 4. Добавление локальных треков
        stream.getTracks().forEach(track => pc.addTrack(track, stream));

        // 5. Настройка канала Ably
        const channel = ably.channels.get(`video-${roomId}`);

        // 6. Атомарный вход в Presence
        await new Promise((resolve, reject) => {
            channel.presence.enter({}, err => {
                if(err) return reject(err);
                resolve();
            });
        });

        // 7. Определение роли
        const members = await channel.presence.get().catch(() => []);
        const isCaller = members.length === 0;
        console.log(`You are ${isCaller ? 'Caller' : 'Callee'}`);

        // 8. Настройка обработчиков сообщений
        channel.subscribe(msg => {
            if(!msg.clientId || msg.clientId === ably.auth.clientId) return;
            
            switch(msg.name) {
                case 'offer': handleOffer(msg.data); break;
                case 'answer': handleAnswer(msg.data); break;
                case 'candidate': handleCandidate(msg.data); break;
            }
        });

        // 9. Инициирование вызова для Caller
        if(isCaller) {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            channel.publish('offer', offer, {clientId: ably.auth.clientId});
        }

        // 10. ICE обработчики
        pc.onicecandidate = e => {
            if(e.candidate) {
                channel.publish('candidate', e.candidate, {clientId: ably.auth.clientId});
            }
        };

        pc.ontrack = e => {
            if(!document.getElementById('remote').srcObject) {
                document.getElementById('remote').srcObject = e.streams[0];
            }
        };

    } catch(err) {
        console.error('Connection error:', err);
    }
}

async function handleOffer(offer) {
    try {
        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ably.channels.get(`video-${roomId}`).publish('answer', answer, {clientId: ably.auth.clientId});
    } catch(err) {
        console.error('Offer handling error:', err);
    }
}

async function handleAnswer(answer) {
    try {
        await pc.setRemoteDescription(new RTCSessionDescription(answer));
    } catch(err) {
        console.error('Answer handling error:', err);
    }
}

async function handleCandidate(candidate) {
    try {
        await pc.addIceCandidate(new RTCIceCandidate(candidate));
    } catch(err) {
        console.error('Candidate error:', err);
    }
}

// Запуск
init();
</script>
</body>
</html>