<!DOCTYPE html>
<html>
<head>
    <title>Final Video Fix</title>
    <!-- Пустая favicon для избежания 404 -->
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
</head>
<body>
    <video id="local" autoplay muted></video>
    <video id="remote" autoplay></video>

<script>
const ABLY_KEY = 'QBEN4A.NpllMw:gKZi9zUxR4vJRISVloUyOSyO969QngOBQNAvtLSr3ZA';
const roomId = new URLSearchParams(location.search).get('room') || 'default';

let pc = null;
let ably = null;

async function init() {
    try {
        // 1. Инициализация Ably с явным clientId (документация section 3.2.2)
        ably = new Ably.Realtime({
            key: ABLY_KEY,
            clientId: 'user-' + Math.random().toString(36).slice(2, 10),
            echoMessages: false // согласно документации section 4.1.5
        });

        // 2. Получение медиапотока
        const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
        document.getElementById('local').srcObject = stream;
        
        // 3. Настройка соединения
        await setupPeerConnection(stream);
        
    } catch(err) {
        console.error('Init error:', err);
    }
}

async function setupPeerConnection(stream) {
    try {
        pc = new RTCPeerConnection({
            iceServers: [{urls: "stun:stun.l.google.com:19302"}]
        });

        // 4. Добавление локальных треков
        stream.getTracks().forEach(track => pc.addTrack(track, stream));

        // 5. Настройка канала с правильным clientId (документация section 4.2.1)
        const channel = ably.channels.get(`video-${roomId}`, {
            params: { clientId: ably.auth.clientId }
        });

        // 6. Атомарный вход в Presence с подтверждением
        await new Promise((resolve, reject) => {
            channel.presence.enter({status: 'active'}, err => {
                err ? reject(err) : resolve();
            });
        });

        // 7. Получение участников с защитой от undefined
        const members = await channel.presence.get().catch(() => []);
        console.log('Current members:', members);
        
        // 8. Определение роли с гарантией
        const isCaller = members.length === 0;
        console.log(`Role: ${isCaller ? 'Caller' : 'Callee'}`);

        // 9. Обработчик сообщений с валидацией clientId
        channel.subscribe(msg => {
            if (!msg.clientId || msg.clientId === ably.auth.clientId) return;
            
            switch(msg.name) {
                case 'offer': 
                    handleOffer(msg.data);
                    break;
                case 'answer':
                    handleAnswer(msg.data);
                    break;
                case 'candidate':
                    handleCandidate(msg.data);
                    break;
            }
        });

        // 10. Инициирование вызова для Caller
        if(isCaller) {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            channel.publish('offer', offer, {clientId: ably.auth.clientId});
        }

        // 11. ICE обработчики
        pc.onicecandidate = e => {
            if(e.candidate) {
                channel.publish('candidate', e.candidate, {clientId: ably.auth.clientId});
            }
        };

        pc.ontrack = e => {
            if(!document.getElementById('remote').srcObject) {
                document.getElementById('remote').srcObject = e.streams[0];
            }
        };

    } catch(err) {
        console.error('Connection error:', err);
    }
}

// ... обработчики offer/answer/candidate остаются без изменений из предыдущего ответа ...

// Запуск
init();
</script>
</body>
</html>