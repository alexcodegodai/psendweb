<!DOCTYPE html>
<html>
<head>
    <title>P2P Video</title>
    <script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
</head>
<body>
    <video id="local" autoplay muted></video>
    <video id="remote" autoplay></video>

<script>
const ABLY_KEY = 'QBEN4A.NpllMw:gKZi9zUxR4vJRISVloUyOSyO969QngOBQNAvtLSr3ZA'; // Ваш ключ
const roomId = new URLSearchParams(location.search).get('room') || 'default';

let pc = new RTCPeerConnection({
    iceServers: [{urls: "stun:stun.l.google.com:19302"}]
});

// 1. Получаем медиапоток
navigator.mediaDevices.getUserMedia({video: true, audio: true})
.then(stream => {
    document.getElementById('local').srcObject = stream;
    stream.getTracks().forEach(track => pc.addTrack(track, stream));
});

// 2. Подключаемся к Ably
const ably = new Ably.Realtime(ABLY_KEY);
const channel = ably.channels.get(`video-room-${roomId}`);

// 3. Определяем роль
channel.presence.enter('user', async () => {
    const members = await channel.presence.get();
    const isCaller = members.length === 1;
    
    // Сигнальный обмен
    channel.subscribe(msg => {
        if(msg.clientId === ably.auth.clientId) return;
        
        if(msg.name === 'offer') {
            pc.setRemoteDescription(new RTCSessionDescription(msg.data));
            pc.createAnswer().then(answer => {
                pc.setLocalDescription(answer);
                channel.publish('answer', answer);
            });
        }
        
        if(msg.name === 'answer') pc.setRemoteDescription(new RTCSessionDescription(msg.data));
        
        if(msg.name === 'candidate') pc.addIceCandidate(new RTCIceCandidate(msg.data));
    });

    // Caller логика
    if(isCaller) {
        pc.createOffer().then(offer => {
            pc.setLocalDescription(offer);
            channel.publish('offer', offer);
        });
    }
});

// ICE кандидаты
pc.onicecandidate = e => {
    if(e.candidate) channel.publish('candidate', e.candidate);
};

// Удаленный поток
pc.ontrack = e => {
    document.getElementById('remote').srcObject = e.streams[0];
};
</script>
</body>
</html>