<!DOCTYPE html>
<html>
<head>
    <title>1:1 Video Fix</title>
    <script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
</head>
<body>
    <video id="local" autoplay muted></video>
    <video id="remote" autoplay></video>

<script>
const ABLY_KEY = 'QBEN4A.NpllMw:gKZi9zUxR4vJRISVloUyOSyO969QngOBQNAvtLSr3ZA';
const roomId = new URLSearchParams(location.search).get('room') || 'default';

let pc = null;
let ably = null;

async function start() {
    try {
        // 1. Инициализация Ably с явным clientId
        ably = new Ably.Realtime({
            key: ABLY_KEY,
            clientId: 'user-' + Math.random().toString(36).substr(2, 8)
        });

        const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
        document.getElementById('local').srcObject = stream;
        setupConnection(stream);
    } catch(err) {
        console.error('Ошибка инициализации:', err);
    }
}

async function setupConnection(stream) {
    try {
        pc = new RTCPeerConnection({
            iceServers: [{urls: "stun:stun.l.google.com:19302"}]
        });

        // Добавление треков
        stream.getTracks().forEach(track => pc.addTrack(track, stream));

        // Настройка канала
        const channel = ably.channels.get(`video-${roomId}`);

        // 2. Атомарный вход в Presence с обработкой ошибок
        await new Promise((resolve, reject) => {
            channel.presence.enter({ status: 'connected' }, err => {
                if(err) return reject(err);
                resolve();
            });
        });

        // 3. Получение участников с защитой от undefined
        const members = await channel.presence.get().catch(() => []);
        const isCaller = members.length === 0;

        console.log(`Роль: ${isCaller ? 'Caller' : 'Callee'}`);

        // 4. Обработчик сообщений с проверкой clientId
        channel.subscribe(msg => {
            if(!msg.clientId || msg.clientId === ably.auth.clientId) return;
            
            switch(msg.name) {
                case 'offer':
                    handleOffer(msg.data);
                    break;
                case 'answer':
                    handleAnswer(msg.data);
                    break;
                case 'candidate':
                    handleCandidate(msg.data);
                    break;
            }
        });

        // 5. Инициация вызова для Caller
        if(isCaller) {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            channel.publish('offer', offer, { clientId: ably.auth.clientId });
        }

        // 6. Обработчики ICE кандидатов
        pc.onicecandidate = e => {
            if(e.candidate) {
                channel.publish('candidate', e.candidate, { clientId: ably.auth.clientId });
            }
        };

        pc.ontrack = e => {
            if(!document.getElementById('remote').srcObject) {
                document.getElementById('remote').srcObject = e.streams[0];
            }
        };

    } catch(err) {
        console.error('Ошибка подключения:', err);
    }
}

async function handleOffer(offer) {
    try {
        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ably.channels.get(`video-${roomId}`).publish('answer', answer, { clientId: ably.auth.clientId });
    } catch(err) {
        console.error('Ошибка обработки offer:', err);
    }
}

async function handleAnswer(answer) {
    try {
        await pc.setRemoteDescription(new RTCSessionDescription(answer));
    } catch(err) {
        console.error('Ошибка обработки answer:', err);
    }
}

async function handleCandidate(candidate) {
    try {
        await pc.addIceCandidate(new RTCIceCandidate(candidate));
    } catch(err) {
        console.error('Ошибка кандидата:', err);
    }
}

start();
</script>
</body>
</html>